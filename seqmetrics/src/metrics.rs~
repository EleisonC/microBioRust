use clap::Parser;
use std::fs::File;
use microBioRust_microSeqIO::gbk::Reader;
use std::io;
use std::collections::HashMap;

#[derive(Parser, Debug)]
#[clap(author, version, about)]
struct Arguments {
  #[clap(short, long)]
  filename: String,
}


// Define a macro to generate the getters for each amino acid
macro_rules! molweight_amino_acid_getters {
    ($struct_name:ident, $( ($field:ident, $full_name:ident, $three_letter:ident, $single_letter:ident) ),* ) => {
        impl $struct_name {
            $(
                // Full name getter
                fn $full_name(&self) -> f64 {
                    self.$field
                }
                // Three-letter code getter
                fn $three_letter(&self) -> f64 {
                    self.$field
                }
                // Single-letter code getter
                fn $single_letter(&self) -> f64 {
                    self.$field
                }
            )*
        }
    };
}

struct MolWeights {
    Alanine: f64,
    Arginine: f64,
    Asparagine: f64,
    Aspartate: f64,
    Cysteine: f64,
    Glutamate: f64,
    Glutamine: f64,
    Glycine: f64,
    Histidine: f64,
    Isoleucine: f64,
    Leucine: f64,
    Lysine: f64,
    Methionine: f64,
    Phenylalanine: f64,
    Proline: f64,
    Serine: f64,
    Threonine: f64,
    Tryptophan: f64,
    Tyrosine: f64,
    Valine: f64,
}

impl MolWeights {
    fn new() -> Self {
       Self {
              Alanine: 71.0779,
              Arginine: 156.18568,
              Asparagine: 114.10264,
              Aspartate: 115.0874,
              Cysteine: 103.1429,
              Glutamate: 129.11398,
              Glutamine: 128.12922,
              Glycine: 57.05132,
              Histidine: 137.13928,
              Isoleucine: 113.15764,
	      Leucine: 113.15764,
              Lysine: 128.09496,
              Methionine: 131.19606,
              Phenylalanine: 147.17386,
              Proline: 97.11518,
              Serine: 87.0773,
              Threonine: 101.10388,
              Tryptophan: 186.2099,
              Tyrosine: 163.17326,
              Valine: 99.13106,
             }
      }
}

pub fn molecular_weight(protein_seq: &str) -> f64 {
    let amino_weights: MolWeights = MolWeights::new();
    molweight_amino_acid_getters!(MolWeights,
             (Alanine, alanine, Ala, A),
             (Arginine, arginine, Arg, R),
             (Asparagine, asparagine, Asn, N),
             (Aspartate, aspartate, Asp, D),
             (Cysteine, cysteine, Cys, C),
             (Glutamine, glutamine, Gln, Q),
             (Glutamate, glutamate, Glu, E),
             (Glycine, glycine, Gly, G),
             (Histidine, histidine, His, H),
             (Isoleucine, isoleucine, Ile, I),
             (Leucine, leucine, Leu, L),
             (Lysine, lysine, Lys, K),
             (Methionine, methionine, Met, M),
             (Phenylalanine, phenylalanine, Phe, F),
             (Proline, proline, Pro, P),
             (Serine, serine, Ser, S),
             (Threonine, threonine, Thr, T),
             (Tryptophan, trytophan, Trp, W),
             (Tyrosine, tyrosine, Tyr, Y),
             (Valine, valine, Val, V)
             );
    let mut total_weight = 0.0;
    for ch in protein_seq.chars() {
       match ch {
           'A' => total_weight += amino_weights.A(),
	   'R' => total_weight += amino_weights.R(),
	   'N' => total_weight += amino_weights.N(),
	   'D' => total_weight += amino_weights.D(),
	   'C' => total_weight += amino_weights.C(),
	   'Q' => total_weight += amino_weights.Q(),
	   'E' => total_weight += amino_weights.E(),
	   'G' => total_weight += amino_weights.G(),
	   'H' => total_weight += amino_weights.H(),
	   'I' => total_weight += amino_weights.I(),
	   'L' => total_weight += amino_weights.L(),
	   'K' => total_weight += amino_weights.K(),
	   'M' => total_weight += amino_weights.M(),
	   'F' => total_weight += amino_weights.F(),
	   'P' => total_weight += amino_weights.P(),
	   'S' => total_weight += amino_weights.S(),
	   'T' => total_weight += amino_weights.T(),
	   'W' => total_weight += amino_weights.W(),
	   'Y' => total_weight += amino_weights.Y(),
	   'V' => total_weight += amino_weights.V(),
	   _ => continue,
	   }
      }
   total_weight
}


    
#[cfg(test)]
mod tests {
    use super::*;

   #[test]
   pub fn collect_molecular_weight() -> Result<(), anyhow::Error> {
            let file_gbk = File::open("test_output.gbk")?;
            let mut reader = Reader::new(file_gbk);
            let mut records = reader.records();
	    let mut counts: HashMap<char, u64> = HashMap::new();
	    let mut molecular_weight_total: f64 = 0.0;
            loop {  
                match records.next() {  
                    Some(Ok(mut record)) => {
                       //println!("next record");
                       //println!("Record id: {:?}", record.id);
                       for (k, _v) in &record.cds.attributes {
                           match record.seq_features.get_sequence_faa(&k) {
                                     Some(value) => { let seq_faa = value.to_string();
				                      molecular_weight_total = molecular_weight(&seq_faa);
                                                      println!(">{}|{}\n{}", &record.id, &k, molecular_weight_total);
                                                      },
                                     _ => (),
                                     };
                       
                           }
                    },
                    Some(Err(e)) => { println!("theres an err {:?}", e); },
                    None => {
                       println!("finished iteration");
                             break; },
                    }
               }
            return Ok(());
   }
}
